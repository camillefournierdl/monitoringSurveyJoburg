---
title: "descriptivesMonitoringPreferences"
output: html_document
---

```{r setup}

# ## clean environment
# # rm(list = ls())
# 
# # Define which packages needed for analyses
# p_needed <-
#   c("tidyverse")
# 
# # Check which packages are already installed on your computer
# packages <- rownames(installed.packages())
# 
# # Check which packages are not installed
# p_to_install <- p_needed[!(p_needed %in% packages)]
# 
# if (length(p_to_install) > 0) {
#   install.packages(p_to_install)
# }
# sapply(p_needed, require, character.only = TRUE)
# 
# 
# # Set an option for the final document that can be produced from the .Rmd file.
# knitr::opts_chunk$set(echo = TRUE)
# 
# ## For replicability: session information 
# session_info <- print(sessionInfo())

library(tidyverse)
library(scales)
library(RColorBrewer)

# Set an option for the final document that can be produced from the .Rmd file.
knitr::opts_chunk$set(echo = TRUE)

## For replicability: session information 
session_info <- print(sessionInfo())

```


```{r load the data}
"%ni%" = Negate("%in%")

set.seed(123)

dataJoburg <- read.csv("data/data_joh_person_anon.csv")

```


```{r data cleaning}
# filter out straightlining for the policies "On days where air pollution is high..."

# Identify columns starting with "AM_GovAction_S"
gov_cols <- grep("^AM_GovAction_S", names(dataJoburg), value = TRUE)

# Calculate the row-wise standard deviation for these columns and filter out straightliners
dataJoburgFilter <- dataJoburg %>%
  mutate(gov_sd = apply(select(., all_of(gov_cols)), 1, sd, na.rm = TRUE)) %>%
  filter(gov_sd != 0) %>%
  select(-gov_sd)

# filter out sl for the effect of more monitoring "More measurements would..."

# Identify columns starting with "AM_effect"
effect_cols <- grep("^AM_effect", names(dataJoburg), value = TRUE)

# Calculate the row-wise standard deviation for these columns and filter out straightliners
dataJoburgFilter2 <- dataJoburgFilter %>%
  mutate(effect_sd = apply(select(., all_of(effect_cols)), 1, sd, na.rm = TRUE)) %>%
  filter(effect_sd != 0) %>%
  select(-effect_sd)

dataJoburg <- dataJoburgFilter2

```


```{r figure pollution population priority}

## summarise
preferencePopPol <- dataJoburg %>%
  filter(!is.na(AM_priority_exposure)) %>% 
  group_by(AM_priority_exposure) %>%
  summarise(count = n(), .groups = "drop") %>%
  mutate(share = count / sum(count),
         label = round(share * 100))

## add a text color column based on concern category
preferencePopPol <- preferencePopPol %>%
  mutate(
    text_color = case_when(
      AM_priority_exposure %in% c("2") ~ "lightgrey",  # light grey text for dark fill
      TRUE ~ "grey28"  # default dark grey for lighter fills
    )
  )
  
#-------------------------------------------------------------------------------
# Plot distribution per city
#-------------------------------------------------------------------------------

## reverse ordering for the plot
preferencePopPol$AM_priority_exposure_cat <- factor(
  preferencePopPol$AM_priority_exposure,
  levels = c("2", "1"),  # reverse order
  labels = c("Where pollution levels are high", "Where most people live"),
  ordered = TRUE
)


p1 <- ggplot(preferencePopPol, aes(x = "", y = share, fill = AM_priority_exposure_cat)) +
  geom_col(width = 0.6) +             # bar height = pct
  geom_text(aes(label = label),
            position = position_stack(vjust = 0.5),
            color = preferencePopPol$text_color,
            size = 3, na.rm = TRUE) +
  coord_flip() +                      # rotate to horizontal
  scale_y_continuous(
    labels = percent_format(accuracy = 1),
    expand = expansion(mult = c(0, 0.02))
  ) +
  scale_fill_manual(values = brewer.pal(3, "BuPu")[c(1,3)],
                    limits = rev(c("Where pollution levels are high", "Where most people live")))+
  labs(
    x    = "",
    y    = "Percentage",
    fill = "Response",
    title = "Where do you think the City of Johannesburg should put\nthese devices first to measure air pollution?\nPick one of these:"
  )+
  theme_minimal()+
  theme(
    legend.position = "top",
    # axis.text = element_text(size = 19),
    # axis.title = element_text(size = 19),
    legend.title = element_blank()
    # legend.text = element_text(size = 16)
  )

ggsave(plot = p1, filename = paste("plots/tradeOffPlacement.png", sep = ""),
       dpi=600, width = 14, height = 8, units='cm')


```


```{r figure monitoring placement amenities}

data_long <- dataJoburg %>%
  pivot_longer(
    cols = starts_with("AM_priority_source"),
    names_to = "item",
    values_to = "rank"
  )

# Count the frequency of rank 1 for each item
rank1_counts <- data_long %>%
  filter(rank == 1) %>%
  count(item)

rank1_counts <- rank1_counts %>%
  mutate(item = factor(
    recode(item,
           `AM_priority_source_1` = "Roads",
           `AM_priority_source_2` = "Hospitals",
           `AM_priority_source_3` = "Schools",
           `AM_priority_source_4` = "Factories",
           `AM_priority_source_5` = "Residential areas"),
    levels = c("Factories", "Residential areas", "Hospitals", "Schools", "Roads")
  ))

# Create a bar chart of the counts
p2 <- ggplot(rank1_counts, aes(x = reorder(item, -n), y = n, fill = item)) +
  geom_col(width = 0.75) +
  labs(
    title = "Where do you think the city government of Johannesburg\nshould put technical devices to measure air pollution?\nMost Common Rank 1",
    x = "",
    y = "Count of Rank 1",
    fill = ""
  )+
  scale_fill_manual(values = brewer.pal(5, "BuPu"))+
  guides(fill="none")+
  theme_minimal()+
  theme(
  plot.title = element_text(size = 8),
  axis.title=element_text(size=7)
  )

p2

ggsave(plot = p2, filename = paste("plots/priorityPlacementRank1.png", sep = ""),
       dpi=600, width = 14, height = 11, units='cm')

data_long <- data_long %>%
  mutate(item = factor(
    recode(item,
           `AM_priority_source_1` = "roads",
           `AM_priority_source_2` = "hospitals",
           `AM_priority_source_3` = "schools",
           `AM_priority_source_4` = "factories",
           `AM_priority_source_5` = "residential areas"),
    levels = c("factories", "residential areas", "hospitals", "schools", "roads")
  ))

p3 <- ggplot(data_long, aes(x = reorder(item, rank, FUN = median, na.rm = TRUE), y = rank, fill = item)) +
  geom_boxplot() +
  labs(
    title = "Where do you think the City of Johannesburg should\nput technical devices to measure air pollution?\n- Ranking Distribution",
    x = "Where to set up monitors in priority?",
    y = "Ranking",
    fill = ""
  )+
  scale_fill_manual(values = brewer.pal(5, "BuPu"))+
  guides(fill="none")

ggsave(plot = p3, filename = paste("plots/priorityPlacementContinuous.png", sep = ""),
       dpi=600, width = 14, height = 11, units='cm')

```


```{r figure interaction monitoring placement amenities}

data_long <- dataJoburg %>%
  pivot_longer(
    cols = starts_with("AM_priority_source"),
    names_to = "item",
    values_to = "rank"
  )

# Count the frequency of rank 1 for each item
rank1_counts <- data_long %>%
  filter(!is.na(AM_priority_exposure)) %>% 
  group_by(AM_priority_exposure) %>% 
  filter(rank == 1) %>%
  count(item)

rank1_counts <- rank1_counts %>%
  mutate(item = factor(
    recode(item,
           `AM_priority_source_1` = "roads",
           `AM_priority_source_2` = "hospitals",
           `AM_priority_source_3` = "schools",
           `AM_priority_source_4` = "factories",
           `AM_priority_source_5` = "residential areas"),
    levels = c("factories", "residential areas", "hospitals", "schools", "roads")
  ))

rank1_counts$AM_priority_exposure_cat <- factor(
  rank1_counts$AM_priority_exposure,
  levels = c("2", "1"),  # reverse order
  labels = c("Where pollution levels are high", "Where most people live"),
  ordered = TRUE
)


# Create a bar chart of the counts
p4 <- ggplot(rank1_counts, aes(x = reorder(item, -n), y = n, fill = item)) +
  geom_col() +
  labs(
    title = "Where do you think the City of Johannesburg should\nput technical devices to measure air pollution?\n- Most Common Rank 1",
    x = "Where to set up monitors in priority?",
    y = "Count of Rank 1",
    fill = ""
  )+
  scale_fill_manual(values = brewer.pal(5, "BuPu"))+
  facet_wrap(~AM_priority_exposure_cat)+
  theme(axis.text.x = element_text(angle = 45, vjust = 0.7))+
  guides(fill="none")

ggsave(plot = p4, filename = paste("plots/priorityPlacementRank1_interaction.png", sep = ""),
       dpi=600, width = 17, height = 13, units='cm')


```


```{r figure interaction economic environment tradeoff}

data_long <- dataJoburg %>%
  pivot_longer(
    cols = starts_with("AM_priority_source"),
    names_to = "item",
    values_to = "rank"
  )

# Count the frequency of rank 1 for each item
rank1_counts <- data_long %>%
  filter(!is.na(envir_tradeoff)) %>% 
  group_by(envir_tradeoff) %>% 
  filter(rank == 1) %>%
  count(item)

rank1_counts <- rank1_counts %>%
  mutate(item = factor(
    recode(item,
           `AM_priority_source_1` = "roads",
           `AM_priority_source_2` = "hospitals",
           `AM_priority_source_3` = "schools",
           `AM_priority_source_4` = "factories",
           `AM_priority_source_5` = "residential areas"),
    levels = c("factories", "residential areas", "hospitals", "schools", "roads")
  ))

rank1_counts$envir_tradeoff_cat <- factor(
  rank1_counts$envir_tradeoff,
  levels = c("2", "1"),  # reverse order
  labels = c("Air pollution is the price we\nhave to pay for more economic growth", "We should reduce air pollution even\nif this means less economic growth"),
  ordered = TRUE
)


# Create a bar chart of the counts
p5 <- ggplot(rank1_counts, aes(x = reorder(item, -n), y = n, fill = item)) +
  geom_col() +
  labs(
    title = "Where do you think the City of Johannesburg should\nput technical devices to measure air pollution?\n- Most Common Rank 1",
    x = "Where to set up monitors in priority?",
    y = "Count of Rank 1",
    fill = ""
  )+
  scale_fill_manual(values = brewer.pal(5, "BuPu"))+
  facet_wrap(~envir_tradeoff_cat)+
  theme(axis.text.x = element_text(angle = 45, vjust = 0.7))+
  guides(fill="none")

ggsave(plot = p5, filename = paste("plots/priorityPlacementRank1_interactionTradeoff.png", sep = ""),
       dpi=600, width = 17, height = 13, units='cm')

```

```{r figure interaction placement tradeoff}

dataJoburg_temp <- dataJoburg %>% 
  filter(!is.na(AM_priority_exposure))

dataJoburg_temp$envir_tradeoff_cat <- factor(
  dataJoburg_temp$envir_tradeoff,
  levels = c("2", "1"),  # reverse order
  labels = c("Air pollution is the price we\nhave to pay for more economic growth", "We should reduce air pollution even\nif this means less economic growth"),
  ordered = TRUE
)

dataJoburg_temp$AM_priority_exposure_cat <- factor(
  dataJoburg_temp$AM_priority_exposure,
  levels = c("2", "1"),  # reverse order
  labels = c("Where pollution levels are high", "Where most people live"),
  ordered = TRUE
)

table(dataJoburg_temp$envir_tradeoff_cat)
table(dataJoburg_temp$AM_priority_exposure_cat)

table(dataJoburg_temp$AM_priority_exposure_cat, dataJoburg_temp$envir_tradeoff_cat)

summary_df <- dataJoburg_temp %>%
  count(envir_tradeoff_cat, AM_priority_exposure_cat) %>%
  group_by(envir_tradeoff_cat) %>%
  mutate(
    share  = n / sum(n),
    # cumulative top of each segment
    y_max  = cumsum(share),
    # bottom of each segment
    y_min  = y_max - share,
    # middle of each segment
    y_mid  = y_min + share / 2,
    label  = percent(share, accuracy = 1),
    text_color = ifelse(share > 0.5, "white", "black")
  ) %>%
  ungroup()

# 2. Plot: one horizontal stacked bar per trade‚Äêoff category
p6 <- ggplot(summary_df,
       aes(x = envir_tradeoff_cat,
           y = share,
           fill = AM_priority_exposure_cat)) +
  geom_col(width = 0.6) +
  geom_text(
    aes(y = y_mid,
        label = label,
        color = text_color),
    size = 3,
    na.rm = TRUE
  ) +
  coord_flip() +  # horizontal bars
  scale_y_continuous(
    labels = percent_format(accuracy = 1),
    expand = expansion(mult = c(0, 0.02))
  ) +
  scale_fill_manual(
    values = brewer.pal(3, "BuPu")[c(1, 3)],
    limits = rev(levels(dataJoburg_temp$AM_priority_exposure_cat))
  ) +
  scale_color_identity() +  # use the precomputed text_color
  labs(
    x     = NULL,
    y     = "Percentage",
    fill  = "Response",
    title = paste0(
      "Where do you think the City of Johannesburg should put\n",
      "these devices first to measure air pollution?\nPick one of these:"
    )
  ) +
  theme_minimal() +
  theme(
    legend.position  = "top",
    legend.title     = element_blank(),
    axis.text.y      = element_text(size = 12),
    panel.grid.major.y = element_blank()
  )

ggsave(plot = p6, filename = paste("plots/interactionTradeoffS.png", sep = ""),
       dpi=600, width = 17, height = 13, units='cm')

```

