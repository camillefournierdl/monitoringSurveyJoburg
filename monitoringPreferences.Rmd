---
title: "descriptivesMonitoringPreferences"
output: html_document
---

```{r setup}

# ## clean environment
# # rm(list = ls())
# 
# # Define which packages needed for analyses
# p_needed <-
#   c("tidyverse")
# 
# # Check which packages are already installed on your computer
# packages <- rownames(installed.packages())
# 
# # Check which packages are not installed
# p_to_install <- p_needed[!(p_needed %in% packages)]
# 
# if (length(p_to_install) > 0) {
#   install.packages(p_to_install)
# }
# sapply(p_needed, require, character.only = TRUE)
# 
# 
# # Set an option for the final document that can be produced from the .Rmd file.
# knitr::opts_chunk$set(echo = TRUE)
# 
# ## For replicability: session information 
# session_info <- print(sessionInfo())

library(tidyverse)

# Set an option for the final document that can be produced from the .Rmd file.
knitr::opts_chunk$set(echo = TRUE)

## For replicability: session information 
session_info <- print(sessionInfo())

```


```{r load the data}
"%ni%" = Negate("%in%")

set.seed(123)

dataJoburg <- read.csv("data/data_joh_person.csv")

```


```{r data cleaning}
# filter out straightlining for the policies "On days where air pollution is high..."

# Identify columns starting with "AM_GovAction_S"
gov_cols <- grep("^AM_GovAction_S", names(dataJoburg), value = TRUE)

# Calculate the row-wise standard deviation for these columns and filter out straightliners
dataJoburgFilter <- dataJoburg %>%
  mutate(gov_sd = apply(select(., all_of(gov_cols)), 1, sd, na.rm = TRUE)) %>%
  filter(gov_sd != 0) %>%
  select(-gov_sd)

# filter out sl for the effect of more monitoring "More measurements would..."

# Identify columns starting with "AM_effect"
effect_cols <- grep("^AM_effect", names(dataJoburg), value = TRUE)

# Calculate the row-wise standard deviation for these columns and filter out straightliners
dataJoburgFilter2 <- dataJoburgFilter %>%
  mutate(effect_sd = apply(select(., all_of(effect_cols)), 1, sd, na.rm = TRUE)) %>%
  filter(effect_sd != 0) %>%
  select(-effect_sd)

dataJoburg <- dataJoburgFilter2

```


```{r figure pollution population priority}

## summarise
preferencePopPol <- dataJoburg %>%
  filter(!is.na(AM_priority_exposure)) %>% 
  group_by(AM_priority_exposure) %>%
  summarise(count = n(), .groups = "drop") %>%
  mutate(share = count / sum(count),
         label = round(share * 100))

## add a text color column based on concern category
preferencePopPol <- preferencePopPol %>%
  mutate(
    text_color = case_when(
      AM_priority_exposure %in% c("2") ~ "lightgrey",  # light grey text for dark fill
      TRUE ~ "grey28"  # default dark grey for lighter fills
    )
  )
  
#-------------------------------------------------------------------------------
# Plot distribution per city
#-------------------------------------------------------------------------------

## reverse ordering for the plot
preferencePopPol$AM_priority_exposure_cat <- factor(
  preferencePopPol$AM_priority_exposure,
  levels = c("2", "1"),  # reverse order
  labels = c("Where pollution levels are high", "Where most people live"),
  ordered = TRUE
)


ggplot(preferencePopPol, aes(x = "", y = share, fill = AM_priority_exposure_cat)) +
  geom_col(width = 0.6) +             # bar height = pct
  geom_text(aes(label = label),
            position = position_stack(vjust = 0.5),
            color = preferencePopPol$text_color,
            size = 7, na.rm = TRUE) +
  coord_flip() +                      # rotate to horizontal
  scale_y_continuous(
    labels = percent_format(accuracy = 1),
    expand = expansion(mult = c(0, 0.02))
  ) +
  scale_fill_manual(values = brewer.pal(3, "BuPu")[c(1,3)],
                    limits = rev(c("Where pollution levels are high", "Where most people live")))+
  labs(
    x    = "",
    y    = "Percentage",
    fill = "Response",
    title = "Where do you think the City of Joburg should put\nthese devices first to measure air pollution? Pick one of these:"
  ) +
  theme_minimal(base_size = 14)+
  theme(
    legend.position = "top",
    axis.text = element_text(size = 19),
    axis.title = element_text(size = 19),
    legend.title = element_blank(),
    legend.text = element_text(size = 16)
  )

```


```{r figure monitoring placement amenities}

data_long <- dataJoburg %>%
  pivot_longer(
    cols = starts_with("AM_priority_source"),
    names_to = "item",
    values_to = "rank"
  )

# Count the frequency of rank 1 for each item
rank1_counts <- data_long %>%
  filter(rank == 1) %>%
  count(item)

rank1_counts <- rank1_counts %>%
  mutate(item = factor(
    recode(item,
           `AM_priority_source_1` = "roads",
           `AM_priority_source_2` = "hospitals",
           `AM_priority_source_3` = "schools",
           `AM_priority_source_4` = "factories",
           `AM_priority_source_5` = "residential areas"),
    levels = c("factories", "residential areas", "hospitals", "schools", "roads")
  ))

# Create a bar chart of the counts
ggplot(rank1_counts, aes(x = reorder(item, -n), y = n, fill = item)) +
  geom_col() +
  labs(
    title = "Where do you think the City of Joburg should\nput technical devices to measure air pollution? - Most Common Rank 1",
    x = "Where to set up monitors in priority?",
    y = "Count of Rank 1",
    fill = ""
  )+
  scale_fill_manual(values = brewer.pal(5, "BuPu"))

data_long <- data_long %>%
  mutate(item = factor(
    recode(item,
           `AM_priority_source_1` = "roads",
           `AM_priority_source_2` = "hospitals",
           `AM_priority_source_3` = "schools",
           `AM_priority_source_4` = "factories",
           `AM_priority_source_5` = "residential areas"),
    levels = c("factories", "residential areas", "hospitals", "schools", "roads")
  ))

ggplot(data_long, aes(x = reorder(item, rank, FUN = median, na.rm = TRUE), y = rank, fill = item)) +
  geom_boxplot() +
  labs(
    title = "Where do you think the City of Joburg should\nput technical devices to measure air pollution? - Ranking Distribution",
    x = "Where to set up monitors in priority?",
    y = "Ranking",
    fill = ""
  )+
  scale_fill_manual(values = brewer.pal(5, "BuPu"))


```


```{r figure interaction monitoring placement amenities}

data_long <- dataJoburg %>%
  pivot_longer(
    cols = starts_with("AM_priority_source"),
    names_to = "item",
    values_to = "rank"
  )

# Count the frequency of rank 1 for each item
rank1_counts <- data_long %>%
  filter(!is.na(AM_priority_exposure)) %>% 
  group_by(AM_priority_exposure) %>% 
  filter(rank == 1) %>%
  count(item)

rank1_counts <- rank1_counts %>%
  mutate(item = factor(
    recode(item,
           `AM_priority_source_1` = "roads",
           `AM_priority_source_2` = "hospitals",
           `AM_priority_source_3` = "schools",
           `AM_priority_source_4` = "factories",
           `AM_priority_source_5` = "residential areas"),
    levels = c("factories", "residential areas", "hospitals", "schools", "roads")
  ))

rank1_counts$AM_priority_exposure_cat <- factor(
  rank1_counts$AM_priority_exposure,
  levels = c("2", "1"),  # reverse order
  labels = c("Where pollution levels are high", "Where most people live"),
  ordered = TRUE
)


# Create a bar chart of the counts
ggplot(rank1_counts, aes(x = reorder(item, -n), y = n, fill = item)) +
  geom_col() +
  labs(
    title = "Where do you think the City of Joburg should\nput technical devices to measure air pollution? - Most Common Rank 1",
    x = "Where to set up monitors in priority?",
    y = "Count of Rank 1",
    fill = ""
  )+
  scale_fill_manual(values = brewer.pal(5, "BuPu"))+
  facet_wrap(~AM_priority_exposure_cat)

data_long <- data_long %>%
  mutate(item = factor(
    recode(item,
           `AM_priority_source_1` = "roads",
           `AM_priority_source_2` = "hospitals",
           `AM_priority_source_3` = "schools",
           `AM_priority_source_4` = "factories",
           `AM_priority_source_5` = "residential areas"),
    levels = c("factories", "residential areas", "hospitals", "schools", "roads")
  ))

ggplot(data_long, aes(x = reorder(item, rank, FUN = median, na.rm = TRUE), y = rank, fill = item)) +
  geom_boxplot() +
  labs(
    title = "Where do you think the City of Joburg should\nput technical devices to measure air pollution? - Ranking Distribution",
    x = "Where to set up monitors in priority?",
    y = "Ranking",
    fill = ""
  )+
  scale_fill_manual(values = brewer.pal(5, "BuPu"))

```
