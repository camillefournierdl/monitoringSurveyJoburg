---
title: "extraAnalysis"
output: html_document
---

```{r setup}

# ## clean environment
# # rm(list = ls())
# 
# # Define which packages needed for analyses
# p_needed <-
#   c("tidyverse", "RColorBrewer", "scales")
# 
# # Check which packages are already installed on your computer
# packages <- rownames(installed.packages())
# 
# # Check which packages are not installed
# p_to_install <- p_needed[!(p_needed %in% packages)]
# 
# if (length(p_to_install) > 0) {
#   install.packages(p_to_install)
# }
# sapply(p_needed, require, character.only = TRUE)
# # 
# ## For replicability: session information 
# session_info <- print(sessionInfo())

library(tidyverse)
library(RColorBrewer)
library(scales)

## For replicability: session information 
session_info <- print(sessionInfo())

```


```{r load the data}
"%ni%" = Negate("%in%")

set.seed(123)

dataJoburg <- read.csv("data/data_joh_person_anon.csv")

```


```{r data cleaning}
# filter out straightlining for the policies "On days where air pollution is high..."

# Identify columns starting with "AM_GovAction_S"
gov_cols <- grep("^AM_GovAction_S", names(dataJoburg), value = TRUE)

# Calculate the row-wise standard deviation for these columns and filter out straightliners
dataJoburgFilter <- dataJoburg %>%
  mutate(gov_sd = apply(select(., all_of(gov_cols)), 1, sd, na.rm = TRUE)) %>%
  filter(gov_sd != 0) %>%
  select(-gov_sd)

# filter out sl for the effect of more monitoring "More measurements would..."

# Identify columns starting with "AM_effect"
effect_cols <- grep("^AM_effect", names(dataJoburg), value = TRUE)

# Calculate the row-wise standard deviation for these columns and filter out straightliners
dataJoburgFilter2 <- dataJoburgFilter %>%
  mutate(effect_sd = apply(select(., all_of(effect_cols)), 1, sd, na.rm = TRUE)) %>%
  filter(effect_sd != 0) %>%
  select(-effect_sd)

dataJoburg <- dataJoburgFilter2

dataJoburg <- subset(dataJoburg, quota_gender.0 %in% c(1,2))
dataJoburg <- subset(dataJoburg, !is.na(quota_gender.0))

dataJoburg$gender <- ifelse(dataJoburg$quota_gender.0 == 1, "male",
                            "female")

# add distance to nearest monitor
distances <- read.csv("revisions/distanceToAQM.csv")

dataJoburg <- merge(dataJoburg, distances, by.x = "X", by.y = "idQualtrix", all.x = T)

dataJoburg$employBin <- ifelse(dataJoburg$employ == "1", "1employed",
                               ifelse(dataJoburg$employ %in% c("3", "4"), "2unemployed", NA))

```

```{r knowledge}

dataJoburg <- dataJoburg %>%
  mutate(AM_Knowlg_1F = factor(recode(AM_Knowlg_1,
                                  `1` = "Would not know",
                                  `2` = " ",
                                  `3` = "Perhaps",
                                  `4` = "  ",
                                  `5` = "Would know"),
                               levels = c("Would not know", " ", "Perhaps", "  ", "Would know"),
                               ordered = TRUE))

dataJoburg$age_group_cat <- ifelse(dataJoburg$quota_age_ == "1", "18-29",
                                 ifelse(dataJoburg$quota_age_ == "2", "30-39",
                                        ifelse(dataJoburg$quota_age_ == "3", "40-49",
                                               ifelse(dataJoburg$quota_age_ == "4", "50-60", NA))))

dataJoburg$education_level_cat <- ifelse(dataJoburg$quota_education == "1", "No ed.",
                                 ifelse(dataJoburg$quota_education == "2", "Grade 1-7",
                                        ifelse(dataJoburg$quota_education == "3", "Grade 8-11",
                                               ifelse(dataJoburg$quota_education == "4", "Grade 12",
                                                      ifelse(dataJoburg$quota_education == "5", "Post matric",
                                                             ifelse(dataJoburg$quota_education == "6", "Bachelor",
                                                                    ifelse(dataJoburg$quota_education == "7", "Master+", NA)))))))

dataJoburg %>%
  filter(!is.na(AM_Knowlg_1F)) %>%
  ggplot(aes(x = AM_Knowlg_1F))+
  labs(x = "If you would want to know how much air pollution there is in Johannesburg,\nwould you know or not know where to find this information?")+
  geom_histogram(stat = "count", binwidth = 1, col = "black", fill = "white")+
  theme_minimal()


### horizontal, nicer looking graphs for first descriptive questions

## summarise
# 1) counts + within-age percentages

## now also including top bar

# --- 1) original per-age-group summary (unchanged) ---
knowledge <- dataJoburg %>%
  filter(!is.na(AM_Knowlg_1), !is.na(age_group_cat)) %>% 
  group_by(age_group_cat, AM_Knowlg_1) %>%
  summarise(count = n(), .groups = "drop_last") %>%
  group_by(age_group_cat) %>%
  mutate(
    share = count / sum(count),
    label = round(share * 100)
  ) %>%
  ungroup()

# --- 2) compute overall summary (across all ages) ---
knowledge_overall <- dataJoburg %>%
  filter(!is.na(AM_Knowlg_1)) %>%
  group_by(AM_Knowlg_1) %>%
  summarise(count = n(), .groups = "drop") %>%
  mutate(
    share = count / sum(count),
    label = round(share * 100),
    age_group_cat = "Overall"  # mark as overall
  )

# --- 3) combine and add plotting helper columns for both datasets ---
knowledge_all <- bind_rows(knowledge, knowledge_overall) %>%
  mutate(
    text_color = case_when(
      AM_Knowlg_1 %in% c("5", "4") ~ "lightgrey",
      TRUE                        ~ "grey28"
    ),
    AM_Knowlg_1_cat = factor(
      AM_Knowlg_1,
      levels = c("5", "4", "3", "2", "1"),
      labels = c("Would know", "   ●   ", "Perhaps", "  ●  ", "Would not know"),
      ordered = TRUE
    )
  )

# --- 4) set age_group_cat order so that "Overall" appears on top after coord_flip()
# Note: with coord_flip(), the last factor level is shown at the top.
existing_levels <- knowledge %>% distinct(age_group_cat) %>% pull(age_group_cat)
age_levels <- c(existing_levels, "Overall")  # put Overall last so it displays at top
knowledge_all <- knowledge_all %>%
  mutate(age_group_cat = factor(age_group_cat, levels = age_levels))

# --- 5) plot ---
p1 <- ggplot(knowledge_all, aes(x = age_group_cat, y = share, fill = AM_Knowlg_1_cat)) +
  geom_col(width = 0.6) +
  geom_text(
    aes(
      label = paste0(round(share * 100), "%"),
      group = AM_Knowlg_1_cat,
      color = text_color
    ),
    position = position_stack(vjust = 0.5),
    size = 3,
    na.rm = TRUE
  ) +
  scale_color_identity() +
  coord_flip() +
  scale_y_continuous(
    labels = percent_format(accuracy = 1),
    expand = expansion(mult = c(0, 0.02))
  ) +
  scale_fill_manual(
    values = brewer.pal(5, "BuPu"),
    limits = rev(c("Would know", "   ●   ", "Perhaps", "  ●  ", "Would not know"))
  ) +
  labs(
    x = "",
    y = "Percentage (overall & for different age groups)",
    fill = "Response",
    title = "If you wanted to know how much air pollution there is in Johannesburg,\nwould you know where to find this information?"
  ) +
  theme_minimal() +
  theme(
    legend.position = "top",
    legend.title = element_blank(),
    plot.title = element_text(size = 10)
  )

p1

ggsave(plot = p1, filename = paste("revisions/plots/knowledgeAge.png", sep = ""),
       dpi=600, width = 15, height = 8, units='cm')

```



```{r knowledgeDistance}

dataJoburg <- dataJoburg %>%
  mutate(
    distance_group = case_when(
      distanceNearestM < 2500              ~ "<2500 m",
      distanceNearestM < 5000 & distanceNearestM > 2500              ~ "<5 km",
      distanceNearestM >= 5000             ~ "≥5 km",
      TRUE                         ~ NA_character_
    ),
    distance_group = factor(distance_group, levels = c("<2500 m", "<5 km","≥5 km"), ordered = TRUE)
  )

# 1) counts + within-distance percentages
knowledge <- dataJoburg %>%
  filter(!is.na(AM_Knowlg_1), !is.na(distance_group)) %>% 
  group_by(distance_group, AM_Knowlg_1) %>%
  summarise(count = n(), .groups = "drop_last") %>%
  group_by(distance_group) %>%
  mutate(
    share = count / sum(count),
    label = round(share * 100)
  ) %>%
  ungroup()

# 2) text color per response category
knowledge <- knowledge %>%
  mutate(
    text_color = case_when(
      AM_Knowlg_1 %in% c("5", "4") ~ "lightgrey",
      TRUE                         ~ "grey28"
    ),
    # 3) ordered/relabeled factor for plotting
    AM_Knowlg_1_cat = factor(
      AM_Knowlg_1,
      levels = c("5", "4", "3", "2", "1"),
      labels = c("Would know", "   ●   ", "Perhaps", "  ●  ", "Would not know"),
      ordered = TRUE
    )
  )

# 4) plot: 100% stacked bars by distance group
pDis <- ggplot(knowledge, aes(x = distance_group, y = share, fill = AM_Knowlg_1_cat)) +
  geom_col(width = 0.6) +
  geom_text(
    aes(
      label = label,                 # or paste0(label, "%")
      group = AM_Knowlg_1_cat,       # align labels with stacks
      color = text_color
    ),
    position = position_stack(vjust = 0.5),
    size = 3, na.rm = TRUE
  ) +
  scale_color_identity() +
  coord_flip() +
  scale_y_continuous(
    labels = percent_format(accuracy = 1),
    expand = expansion(mult = c(0, 0.02))
  ) +
  scale_fill_manual(
    values = RColorBrewer::brewer.pal(5, "BuPu"),
    limits = rev(c("Would know", "   ●   ", "Perhaps", "  ●  ", "Would not know"))
  ) +
  labs(
    x = "",
    y = "Percentage (within distance group)",
    fill = "Response",
    title = "If you wanted to know how much air pollution there is in Johannesburg,\nwould you know where to find this information? (by distance to monitor)"
  ) +
  theme_minimal() +
  theme(
    legend.position = "top",
    legend.title = element_blank()
  )

pDis

ggsave(plot = pDis, filename = paste("revisions/plots/knowledgeDistance.png", sep = ""),
       dpi=600, width = 18, height = 10, units='cm')


```


```{r frequencyInfo}

# 1) counts + within-age percentages
## add overall bar

# --- 1) per-age-group summary (base) ---
freqJ_base <- dataJoburg %>%
  filter(!is.na(AM_Freq), !is.na(age_group_cat)) %>% 
  group_by(age_group_cat, AM_Freq) %>%
  summarise(count = n(), .groups = "drop_last") %>%
  group_by(age_group_cat) %>%
  mutate(
    share = count / sum(count),
    label = round(share * 100)
  ) %>%
  ungroup()

# --- 2) overall summary across all ages ---
freqJ_overall <- dataJoburg %>%
  filter(!is.na(AM_Freq)) %>%
  group_by(AM_Freq) %>%
  summarise(count = n(), .groups = "drop") %>%
  mutate(
    share = count / sum(count),
    label = round(share * 100),
    age_group_cat = "Overall"
  )

# --- 3) combine, add plotting helpers ---
freqJ_all <- bind_rows(freqJ_base, freqJ_overall) %>%
  mutate(
    text_color = case_when(
      AM_Freq %in% c("3") ~ "lightgrey",
      TRUE                ~ "grey28"
    ),
    AM_Freq_cat = factor(
      AM_Freq,
      levels = c("3", "2", "1"),
      labels = c("Often", "Rarely", "Never"),
      ordered = TRUE
    )
  )

# --- 4) ensure ordering so "Overall" appears at the top after coord_flip() ---
existing_levels <- freqJ_base %>% distinct(age_group_cat) %>% pull(age_group_cat)
# Put Overall last so it displays at the top when coord_flip() is used
age_levels <- c(existing_levels, "Overall")
freqJ_all <- freqJ_all %>%
  mutate(age_group_cat = factor(age_group_cat, levels = age_levels))

# --- 5) plot (100% stacked with Overall on top) ---
p2 <- ggplot(freqJ_all, aes(x = age_group_cat, y = share, fill = AM_Freq_cat)) +
  geom_col(width = 0.6) +
  geom_text(
    aes(
      label = paste0(label, "%"),
      group = AM_Freq_cat,
      color = text_color
    ),
    position = position_stack(vjust = 0.5),
    size = 3,
    na.rm = TRUE
  ) +
  scale_color_identity() +
  coord_flip() +
  scale_y_continuous(
    labels = percent_format(accuracy = 1),
    expand = expansion(mult = c(0, 0.02))
  ) +
  scale_fill_manual(
    values = brewer.pal(3, "BuPu"),
    limits = rev(c("Often", "Rarely", "Never"))
  ) +
  labs(
    x = "",
    y = "Percentage (overall & for different age groups)",
    fill = "Response",
    title = "How often or not do you look up information on air pollution in Johannesburg?"
  ) +
  theme_minimal() +
  theme(
    legend.position = "top",
    legend.title = element_blank(),
    plot.title = element_text(size = 10)
  )

p2

ggsave(plot = p2, filename = "revisions/plots/frequencyAge.png",
       dpi = 600, width = 15, height = 8, units = "cm")
```


```{r frequencyDistance}

dataJoburg <- dataJoburg %>%
  mutate(
    distance_group = case_when(
      distanceNearestM < 2500              ~ "<2500 m",
      distanceNearestM < 5000 & distanceNearestM > 2500              ~ "<5 km",
      distanceNearestM >= 5000             ~ "≥5 km",
      TRUE                         ~ NA_character_
    ),
    distance_group = factor(distance_group, levels = c("<2500 m", "<5 km","≥5 km"), ordered = TRUE)
  )

freqJ <- dataJoburg %>%
  filter(!is.na(AM_Freq), !is.na(distance_group)) %>% 
  group_by(distance_group, AM_Freq) %>%
  summarise(count = n(), .groups = "drop_last") %>%
  group_by(distance_group) %>%
  mutate(
    share = count / sum(count),
    label = round(share * 100)
  ) %>%
  ungroup() %>%
  # 2) text color per response category
  mutate(
    text_color = case_when(
      AM_Freq %in% c("3") ~ "lightgrey",  # light text for darkest fill
      TRUE                ~ "grey28"
    ),
    # 3) ordered/relabeled factor for plotting
    AM_Freq_cat = factor(
      AM_Freq,
      levels = c("3", "2", "1"),
      labels = c("Often", "Rarely", "Never"),
      ordered = TRUE
    )
  )


# 4) plot: 100% stacked bars by distance group
pDis <- ggplot(freqJ, aes(x = distance_group, y = share, fill = AM_Freq_cat)) +
  geom_col(width = 0.6) +
  geom_text(
    aes(
      label = label,                 # or paste0(label, "%")
      group = AM_Freq_cat,       # align labels with stacks
      color = text_color
    ),
    position = position_stack(vjust = 0.5),
    size = 3, na.rm = TRUE
  ) +
  scale_color_identity() +
  coord_flip() +
  scale_y_continuous(
    labels = percent_format(accuracy = 1),
    expand = expansion(mult = c(0, 0.02))
  ) +
  scale_fill_manual(
      values = brewer.pal(3, "BuPu"),
      limits = rev(c("Often", "Rarely", "Never"))
    ) +  labs(
    x = "",
    y = "Percentage (within distance group)",
    fill = "Response",
    title = "How often or not do you look up information on air pollution in Johannesburg? (by distance to monitor)"
  ) +
  theme_minimal() +
  theme(
    legend.position = "top",
    legend.title = element_blank()
  )

pDis

ggsave(plot = pDis, filename = paste("revisions/plots/frequencyDistance.png", sep = ""),
       dpi=600, width = 18, height = 10, units='cm')


```




```{r satisfaction}

# 1) counts + within-age percentages
satisfaction <- dataJoburg %>%
  filter(!is.na(AM_Perc), !is.na(age_group_cat)) %>% 
  group_by(age_group_cat, AM_Perc) %>%
  summarise(count = n(), .groups = "drop_last") %>%
  group_by(age_group_cat) %>%
  mutate(
    share = count / sum(count),
    label = round(share * 100)
  ) %>%
  ungroup() %>%
  # 2) text color + factor relabel
  mutate(
    text_color = case_when(
      AM_Perc %in% c("3") ~ "lightgrey",   # light text for darkest fill
      TRUE                ~ "grey28"
    ),
    AM_Perc_cat = factor(
      AM_Perc,
      levels = c("3", "2", "1"),           # reverse order
      labels = c("Good job", "Moderate job", "Bad job"),
      ordered = TRUE
    )
  )

# 3) plot: 100% stacked bars per age group
p3 <- ggplot(satisfaction, aes(x = age_group_cat, y = share, fill = AM_Perc_cat)) +
  geom_col(width = 0.6) +
  geom_text(
    aes(
      label = label,              # or paste0(label, "%") for the % sign
      group = AM_Perc_cat,        # keep labels centered on their stack
      color = text_color
    ),
    position = position_stack(vjust = 0.5),
    size = 3,
    na.rm = TRUE
  ) +
  scale_color_identity() +
  coord_flip() +
  scale_y_continuous(
    labels = percent_format(accuracy = 1),
    expand = expansion(mult = c(0, 0.02))
  ) +
  scale_fill_manual(
    values = brewer.pal(3, "BuPu"),
    limits = rev(c("Good job", "Moderate job", "Bad job"))
  ) +
  labs(
    x = "",
    y = "Percentage (within age group)",
    fill = "Response",
    title = "In your view, has the city government of Johannesburg done a good job or bad job\nin informing people about air pollution? (by age group)"
  ) +
  theme_minimal() +
  theme(
    legend.position = "top",
    legend.title = element_blank()
  )

p3

ggsave(plot = p3, filename = paste("revisions/plots/satisfactionAge.png", sep = ""),
       dpi=600, width = 18, height = 10, units='cm')


```

```{r satisfaction education}

# 1) counts + within-age percentages

## with overall bar on top

# --- 1) per-education-group summary (base) ---
satisfaction_base <- dataJoburg %>%
  filter(!is.na(AM_Perc), !is.na(education_level_cat)) %>% 
  group_by(education_level_cat, AM_Perc) %>%
  summarise(count = n(), .groups = "drop_last") %>%
  group_by(education_level_cat) %>%
  mutate(
    share = count / sum(count),
    label = round(share * 100)
  ) %>%
  ungroup()

# --- 2) overall summary across all education levels ---
satisfaction_overall <- dataJoburg %>%
  filter(!is.na(AM_Perc)) %>%
  group_by(AM_Perc) %>%
  summarise(count = n(), .groups = "drop") %>%
  mutate(
    share = count / sum(count),
    label = round(share * 100),
    education_level_cat = "Overall"
  )

# --- 3) combine and add plotting helpers ---
satisfaction_all <- bind_rows(satisfaction_base, satisfaction_overall) %>%
  mutate(
    text_color = case_when(
      AM_Perc %in% c("3") ~ "lightgrey",   # light text for darkest fill
      TRUE                ~ "grey28"
    ),
    AM_Perc_cat = factor(
      AM_Perc,
      levels = c("3", "2", "1"),
      labels = c("Good job", "Moderate job", "Bad job"),
      ordered = TRUE
    )
  )

# --- 4) set ordering so "Overall" appears at the top after coord_flip() ---
edu_levels <- c("No ed.","Grade 1-7","Grade 8-11","Grade 12","Post matric","Bachelor","Master+")
# put "Overall" last so it will display at the top when coord_flip() is used
edu_levels_with_overall <- c(edu_levels, "Overall")
satisfaction_all <- satisfaction_all %>%
  mutate(education_level_cat = factor(education_level_cat, levels = edu_levels_with_overall))

# --- 5) plot (100% stacked with Overall on top) ---
p3 <- ggplot(satisfaction_all, aes(x = education_level_cat, y = share, fill = AM_Perc_cat)) +
  geom_col(width = 0.6) +
  geom_text(
    aes(
      label = paste0(label, "%"),
      group = AM_Perc_cat,
      color = text_color
    ),
    position = position_stack(vjust = 0.5),
    size = 3,
    na.rm = TRUE
  ) +
  scale_color_identity() +
  coord_flip() +
  scale_y_continuous(
    labels = percent_format(accuracy = 1),
    expand = expansion(mult = c(0, 0.02))
  ) +
  scale_fill_manual(
    values = brewer.pal(3, "BuPu"),
    limits = rev(c("Good job", "Moderate job", "Bad job"))
  ) +
  labs(
    x = "",
    y = "Percentage (overall & for different education levels)",
    fill = "Response",
    title = "In your view, has the city government of Johannesburg done a good job\n or bad job in informing people about air pollution?"
  ) +
  theme_minimal() +
  theme(
    legend.position = "top",
    legend.title = element_blank(),
    plot.title = element_text(size = 10)
  )

p3

ggsave(plot = p3, filename = paste("revisions/plots/satisfactionEduc.png", sep = ""),
       dpi=600, width = 15, height = 8, units='cm')


```

```{r satisfactionDistance}

dataJoburg <- dataJoburg %>%
  mutate(
    distance_group = case_when(
      distanceNearestM < 2500              ~ "<2500 m",
      distanceNearestM < 5000 & distanceNearestM > 2500              ~ "<5 km",
      distanceNearestM >= 5000             ~ "≥5 km",
      TRUE                         ~ NA_character_
    ),
    distance_group = factor(distance_group, levels = c("<2500 m", "<5 km","≥5 km"), ordered = TRUE)
  )

satisfaction <- dataJoburg %>%
  filter(!is.na(AM_Perc), !is.na(distance_group)) %>% 
  group_by(distance_group, AM_Perc) %>%
  summarise(count = n(), .groups = "drop_last") %>%
  group_by(distance_group) %>%
  mutate(
    share = count / sum(count),
    label = round(share * 100)
  ) %>%
  ungroup() %>%
  # 2) text color + factor relabel
  mutate(
    text_color = case_when(
      AM_Perc %in% c("3") ~ "lightgrey",   # light text for darkest fill
      TRUE                ~ "grey28"
    ),
    AM_Perc_cat = factor(
      AM_Perc,
      levels = c("3", "2", "1"),           # reverse order
      labels = c("Good job", "Moderate job", "Bad job"),
      ordered = TRUE
    )
  )

# 4) plot: 100% stacked bars by distance group
pDis <- ggplot(satisfaction, aes(x = distance_group, y = share, fill = AM_Perc_cat)) +
  geom_col(width = 0.6) +
  geom_text(
    aes(
      label = label,                 # or paste0(label, "%")
      group = AM_Perc_cat,       # align labels with stacks
      color = text_color
    ),
    position = position_stack(vjust = 0.5),
    size = 3, na.rm = TRUE
  ) +
  scale_color_identity() +
  coord_flip() +
  scale_y_continuous(
    labels = percent_format(accuracy = 1),
    expand = expansion(mult = c(0, 0.02))
  ) +
  scale_fill_manual(
    values = brewer.pal(3, "BuPu"),
    limits = rev(c("Good job", "Moderate job", "Bad job"))
  ) +
 labs(
    x = "",
    y = "Percentage (within distance group)",
    fill = "Response",
    title = "How often or not do you look up information on air pollution in Johannesburg? (by distance to monitor)"
  ) +
  theme_minimal() +
  theme(
    legend.position = "top",
    legend.title = element_blank()
  )

pDis

ggsave(plot = pDis, filename = paste("revisions/plots/satisfactionDistance.png", sep = ""),
       dpi=600, width = 18, height = 10, units='cm')

```

```{r models}

library(modelsummary)
library(flextable)

# knowledge
lm(AM_Knowlg_1~quota_age_ + quota_education*gender + distanceNearestM, data = dataJoburg) %>% summary(.)
lm(AM_Knowlg_1~quota_age_ + quota_education*gender, data = dataJoburg) %>% summary(.)

lm(AM_Knowlg_1~quota_age_ + quota_education*gender + distanceNearestM + perception_spatial, data = dataJoburg) %>% summary(.)
lm(AM_Knowlg_1~quota_age_ + quota_education+gender + distanceNearestM + perception_spatial, data = dataJoburg) %>% summary(.)

lm(AM_Knowlg_1~quota_age_ + quota_education*gender + employBin + employBin:quota_education, data = dataJoburg) %>% summary(.)

## perception
lm(AM_Perc~quota_age_ + quota_education + gender + distanceNearestM, data = dataJoburg) %>% summary(.)
lm(AM_Perc~quota_age_ + quota_education + gender, data = dataJoburg) %>% summary(.)

lm(AM_Perc~quota_age_ + quota_education + gender + employBin + employBin:quota_education, data = dataJoburg) %>% summary(.)

# frequency
lm(AM_Freq~quota_age_ + quota_education*gender + distanceNearestM, data = dataJoburg) %>% summary(.)
lm(AM_Freq~quota_age_ + quota_education*gender, data = dataJoburg) %>% summary(.)

lm(AM_Freq~quota_age_ + quota_education*gender + employBin + employBin:quota_education, data = dataJoburg) %>% summary(.)

####### knowledge

# 1) list of formulas from simplest to most complex
forms <- list(
  "Education" = "AM_Knowlg_1 ~ quota_education + perception_spatial",
  "Age"       = "AM_Knowlg_1 ~ quota_age_ + perception_spatial",
  "AddEdu"    = "AM_Knowlg_1 ~ quota_age_ + quota_education + perception_spatial",
  "AddGender" = "AM_Knowlg_1 ~ quota_age_ + quota_education + gender + perception_spatial",
  "Interact"  = "AM_Knowlg_1 ~ quota_age_ + quota_education * gender + perception_spatial",
  "Full"      = "AM_Knowlg_1 ~ quota_age_ + quota_education * gender + distanceNearestM + perception_spatial"
)

# 2) fit models in one line with lapply
models <- lapply(forms, function(f) lm(as.formula(f), data = dataJoburg))

# 3) (optional) nicer coefficient labels
coef_map <- c(
  "(Intercept)" = "(Intercept)",
  "quota_age_" = "Age",
  "perception_spatial" = "Perception (spatial)",
  "quota_education" = "Education",
  "gendermale" = "Gender",
  "quota_education:gendermale" = "Education × Gender",
  "distanceNearestM" = "Distance (m)"
)

# 4) single tidy table (estimates, SEs, p-values, stars)
modelsummary(models,
             coef_map = coef_map,
             fmt = 3,                # digits
             statistic = c("std.error","p.value"),
             stars = TRUE)

# 4) build a flextable from modelsummary
summary_ft <- modelsummary(
  models,
  coef_map  = coef_map,
  fmt       = 3,
  statistic = c("({std.error})"),  # SEs on one line, p on next
  stars     = TRUE,
  gof_omit  = "Log|RMSE",                    # optional: hide some GOF rows
  output    = "flextable"
)

# (optional) polish the table
summary_ft <- autofit(summary_ft)
# summary_ft <- add_footer_lines(summary_ft, "+ p < 0.1, * p < 0.05, ** p < 0.01, *** p < 0.001")

# 5) save to Word
flextable::save_as_docx("Table S2. Model summary" = summary_ft,
                        path = "revisions/tables/summaryTableKnowledge.docx")

####### perception

# 1) list of formulas from simplest to most complex
forms <- list(
  "Education" = "AM_Perc ~ quota_education + perception_spatial",
  "Age"       = "AM_Perc ~ quota_age_ + perception_spatial",
  "AddEdu"    = "AM_Perc ~ quota_age_ + quota_education + perception_spatial",
  "AddGender" = "AM_Perc ~ quota_age_ + quota_education + gender + perception_spatial",
  "Interact"  = "AM_Perc ~ quota_age_ + quota_education * gender + perception_spatial",
  "Full"      = "AM_Perc ~ quota_age_ + quota_education * gender + distanceNearestM + perception_spatial"
)

# 2) fit models in one line with lapply
models <- lapply(forms, function(f) lm(as.formula(f), data = dataJoburg))

# 3) (optional) nicer coefficient labels
coef_map <- c(
  "(Intercept)" = "(Intercept)",
  "quota_age_" = "Age",
  "perception_spatial" = "Perception (spatial)",
  "quota_education" = "Education",
  "gendermale" = "Gender",
  "quota_education:gendermale" = "Education × Gender",
  "distanceNearestM" = "Distance (m)"
)

# 4) single tidy table (estimates, SEs, p-values, stars)
modelsummary(models,
             coef_map = coef_map,
             fmt = 3,                # digits
             statistic = c("std.error","p.value"),
             stars = TRUE)

# 4) build a flextable from modelsummary
summary_ft <- modelsummary(
  models,
  coef_map  = coef_map,
  fmt       = 3,
  statistic = c("({std.error})"),  # SEs on one line, p on next
  stars     = TRUE,
  gof_omit  = "Log|RMSE",                    # optional: hide some GOF rows
  output    = "flextable"
)


# (optional) polish the table
summary_ft <- autofit(summary_ft)
# summary_ft <- add_footer_lines(summary_ft, "+ p < 0.1, * p < 0.05, ** p < 0.01, *** p < 0.001")

# 5) save to Word
flextable::save_as_docx("Table S4. Model summary" = summary_ft,
                        path = "revisions/tables/summaryTableSatisfaction.docx")

####### frequency

# 1) list of formulas from simplest to most complex
forms <- list(
  "Education"       = "AM_Freq ~ quota_education + perception_spatial",
  "Age"       = "AM_Freq ~ quota_age_ + perception_spatial",
  "AddEdu"    = "AM_Freq ~ quota_age_ + quota_education + perception_spatial",
  "AddGender" = "AM_Freq ~ quota_age_ + quota_education + gender + perception_spatial",
  "Interact"  = "AM_Freq ~ quota_age_ + quota_education * gender + perception_spatial",
  "Full"      = "AM_Freq ~ quota_age_ + quota_education * gender + distanceNearestM + perception_spatial"
)

# 2) fit models in one line with lapply
models <- lapply(forms, function(f) lm(as.formula(f), data = dataJoburg))

# 3) (optional) nicer coefficient labels
coef_map <- c(
  "(Intercept)" = "(Intercept)",
  "quota_age_" = "Age",
  "perception_spatial" = "Perception (spatial)",
  "quota_education" = "Education",
  "gendermale" = "Gender",
  "quota_education:gendermale" = "Education × Gender",
  "distanceNearestM" = "Distance (m)"
)

# 4) single tidy table (estimates, SEs, p-values, stars)
modelsummary(models,
             coef_map = coef_map,
             fmt = 3,                # digits
             statistic = c("std.error"),
             stars = TRUE)

# 4) build a flextable from modelsummary
summary_ft <- modelsummary(
  models,
  coef_map  = coef_map,
  fmt       = 3,
  statistic = c("({std.error})"),  # SEs on one line, p on next
  stars     = TRUE,
  gof_omit  = "Log|RMSE",                    # optional: hide some GOF rows
  output    = "flextable"
)

# (optional) polish the table
summary_ft <- autofit(summary_ft)
# summary_ft <- add_footer_lines(summary_ft, "+ p < 0.1, * p < 0.05, ** p < 0.01, *** p < 0.001")

# 5) save to Word
flextable::save_as_docx("Table S3. Model summary" = summary_ft,
                        path = "revisions/tables/summaryTableFrequency.docx")

## full table

# 1) list of formulas from simplest to most complex
forms <- list(
  "Knowledge" = "AM_Knowlg_1 ~ quota_age_ + quota_education * gender + perception_spatial",
  "K+dist"       = "AM_Knowlg_1 ~ quota_age_ + quota_education * gender + distanceNearestM + perception_spatial",
  "Frequency"    = "AM_Freq ~ quota_age_ + quota_education * gender + perception_spatial",
  "F+dist" = "AM_Freq ~ quota_age_ + quota_age_ + quota_education * gender + distanceNearestM + perception_spatial",
  "Satisfaction"  = "AM_Perc ~ quota_age_ + quota_education * gender + perception_spatial",
  "S+dist"      = "AM_Perc ~ quota_age_ + quota_education * gender + distanceNearestM + perception_spatial"
)

# 2) fit models in one line with lapply
models <- lapply(forms, function(f) lm(as.formula(f), data = dataJoburg))

# 3) (optional) nicer coefficient labels
coef_map <- c(
  "(Intercept)" = "(Intercept)",
  "quota_age_" = "Age",
  "perception_spatial" = "Perception (spatial)",
  "quota_education" = "Education",
  "gendermale" = "Gender",
  "quota_education:gendermale" = "Education × Gender",
  "distanceNearestM" = "Distance (m)"
)

# 4) single tidy table (estimates, SEs, p-values, stars)
summary_ft <- modelsummary(models,
             coef_map = coef_map,
             fmt = 3,                # digits
             statistic = c("std.error","p.value"),
             stars = TRUE)

# 4) build a flextable from modelsummary
summary_ft <- modelsummary(
  models,
  coef_map  = coef_map,
  fmt       = 3,
  statistic = c("({std.error})"),  # SEs on one line, p on next
  stars     = TRUE,
  gof_omit  = "IC|Log|F|RMSE",                    # optional: hide some GOF rows
  output    = "flextable"
)

# (optional) polish the table
summary_ft <- autofit(summary_ft)
# summary_ft <- add_footer_lines(summary_ft, "+ p < 0.1, * p < 0.05, ** p < 0.01, *** p < 0.001")

# 5) save to Word
flextable::save_as_docx("Table S1. Model summary" = summary_ft,
                        path = "revisions/tables/summaryTableKFS.docx")

```



```{r perceived exposure}

dataJoburg$perception_current
dataJoburg$perception_spatial
dataJoburg$concern_gen

cor(dataJoburg$perception_current, dataJoburg$perception_spatial, method = "spearman")

```



```{r boxplots}

dataJoburg %>%
  filter(!is.na(AM_Knowlg_1)) %>%
  ggplot(aes(y = AM_Knowlg_1, x = age_group_cat))+
  labs(y = "If you would want to know how much air pollution there is in Johannesburg,\nwould you know or not know where to find this information?",
       x = "Age Group")+
  geom_boxplot(col = "black", fill = "white")+
  theme_minimal()


dataJoburg %>%
  filter(!is.na(AM_Perc)) %>%
  ggplot(aes(y = AM_Perc, x = age_group_cat))+
  labs(y = "",
       x = "Age Group")+
  geom_boxplot(col = "black", fill = "white")+
  theme_minimal()

dataJoburg %>%
  filter(!is.na(AM_Freq)) %>%
  ggplot(aes(y = AM_Freq, x = age_group_cat))+
  labs(y = "",
       x = "Age Group")+
  geom_boxplot(col = "black", fill = "white")+
  theme_minimal()

```





